#!/usr/bin/env perl
use strict;
use warnings;
# Input from "PIH Uganda" spreadsheet online

use List::MoreUtils qw/zip/;
use feature 'say';

#curl --silent 'https://www.ebi.ac.uk/ena/portal/api/filereport?accession=PRJNA512122&result=read_run&fields=sample_accession,secondary_sample_accession,run_accession'
my $payload = <<EOF;
sample_accession	secondary_sample_accession	run_accession
SAMN10442510	SRS4060442	SRR8210271
SAMN10442509	SRS4060441	SRR8210272
SAMN10442508	SRS4060440	SRR8210273
SAMN10442507	SRS4060439	SRR8210274
SAMN10442513	SRS4060438	SRR8210275
SAMN10442512	SRS4060437	SRR8210276
SAMN10442511	SRS4060436	SRR8210277
SAMN10450553	SRS4060960	SRR8216065
SAMN10450500	SRS4060959	SRR8216066
SAMN10450483	SRS4060958	SRR8216067
SAMN10450585	SRS4060957	SRR8216068
SAMN10450586	SRS4060956	SRR8216069
SAMN10450583	SRS4060955	SRR8216070
SAMN10450584	SRS4060954	SRR8216071
SAMN10450581	SRS4060953	SRR8216072
SAMN10450582	SRS4060952	SRR8216073
SAMN10450579	SRS4060951	SRR8216074
SAMN10450580	SRS4060950	SRR8216075
SAMN10450507	SRS4060949	SRR8216076
SAMN10450508	SRS4060948	SRR8216077
SAMN10450482	SRS4060947	SRR8216078
SAMN10450427	SRS4060946	SRR8216079
SAMN10450428	SRS4060945	SRR8216080
SAMN10450480	SRS4060944	SRR8216081
SAMN10450419	SRS4060943	SRR8216082
SAMN10450420	SRS4060942	SRR8216083
SAMN10450421	SRS4060941	SRR8216084
SAMN10450422	SRS4060940	SRR8216085
SAMN10450423	SRS4060939	SRR8216086
SAMN10450424	SRS4060938	SRR8216087
SAMN10450425	SRS4060937	SRR8216088
SAMN10450426	SRS4060936	SRR8216089
SAMN10450505	SRS4060935	SRR8216090
SAMN10450486	SRS4060934	SRR8216091
SAMN10450417	SRS4060933	SRR8216092
SAMN10450418	SRS4060932	SRR8216093
SAMN10450413	SRS4060931	SRR8216094
SAMN10450414	SRS4060930	SRR8216095
SAMN10450415	SRS4060928	SRR8216096
SAMN10450416	SRS4060929	SRR8216097
SAMN10450409	SRS4060927	SRR8216098
SAMN10450410	SRS4060926	SRR8216099
SAMN10450411	SRS4060925	SRR8216100
SAMN10450412	SRS4060924	SRR8216101
SAMN10450504	SRS4060923	SRR8216102
SAMN10450506	SRS4060922	SRR8216103
SAMN10450574	SRS4060921	SRR8216104
SAMN10450573	SRS4060920	SRR8216105
SAMN10450576	SRS4060919	SRR8216106
SAMN10450575	SRS4060918	SRR8216107
SAMN10450570	SRS4060917	SRR8216108
SAMN10450569	SRS4060916	SRR8216109
SAMN10450572	SRS4060915	SRR8216110
SAMN10450571	SRS4060914	SRR8216111
SAMN10450578	SRS4060913	SRR8216112
SAMN10450577	SRS4060912	SRR8216113
SAMN10450434	SRS4060911	SRR8216114
SAMN10450433	SRS4060910	SRR8216115
SAMN10450436	SRS4060909	SRR8216116
SAMN10450435	SRS4060908	SRR8216117
SAMN10450430	SRS4060907	SRR8216118
SAMN10450429	SRS4060906	SRR8216119
SAMN10450432	SRS4060905	SRR8216120
SAMN10450431	SRS4060904	SRR8216121
SAMN10450438	SRS4060903	SRR8216122
SAMN10450437	SRS4060902	SRR8216123
SAMN10450519	SRS4060901	SRR8216124
SAMN10450520	SRS4060900	SRR8216125
SAMN10450521	SRS4060899	SRR8216126
SAMN10450522	SRS4060898	SRR8216127
SAMN10450523	SRS4060897	SRR8216128
SAMN10450524	SRS4060896	SRR8216129
SAMN10450525	SRS4060895	SRR8216130
SAMN10450526	SRS4060894	SRR8216131
SAMN10450527	SRS4060893	SRR8216132
SAMN10450528	SRS4060892	SRR8216133
SAMN10450445	SRS4060890	SRR8216134
SAMN10450446	SRS4060891	SRR8216135
SAMN10450443	SRS4060889	SRR8216136
SAMN10450444	SRS4060888	SRR8216137
SAMN10450441	SRS4060887	SRR8216138
SAMN10450442	SRS4060886	SRR8216139
SAMN10450439	SRS4060885	SRR8216140
SAMN10450440	SRS4060884	SRR8216141
SAMN10450447	SRS4060883	SRR8216142
SAMN10450448	SRS4060882	SRR8216143
SAMN10450481	SRS4060881	SRR8216144
SAMN10450518	SRS4060880	SRR8216145
SAMN10450517	SRS4060879	SRR8216146
SAMN10450516	SRS4060878	SRR8216147
SAMN10450515	SRS4060877	SRR8216148
SAMN10450514	SRS4060876	SRR8216149
SAMN10450513	SRS4060875	SRR8216150
SAMN10450512	SRS4060874	SRR8216151
SAMN10450511	SRS4060873	SRR8216152
SAMN10450510	SRS4060872	SRR8216153
SAMN10450509	SRS4060871	SRR8216154
SAMN10450452	SRS4060870	SRR8216155
SAMN10450451	SRS4060868	SRR8216156
SAMN10450450	SRS4060869	SRR8216157
SAMN10450449	SRS4060867	SRR8216158
SAMN10450456	SRS4060865	SRR8216159
SAMN10450455	SRS4060866	SRR8216160
SAMN10450454	SRS4060864	SRR8216161
SAMN10450453	SRS4060863	SRR8216162
SAMN10450458	SRS4060862	SRR8216163
SAMN10450457	SRS4060861	SRR8216164
SAMN10450501	SRS4060859	SRR8216165
SAMN10450502	SRS4060860	SRR8216166
SAMN10450503	SRS4060858	SRR8216167
SAMN10450547	SRS4060857	SRR8216168
SAMN10450548	SRS4060856	SRR8216169
SAMN10450541	SRS4060855	SRR8216170
SAMN10450542	SRS4060853	SRR8216171
SAMN10450539	SRS4060854	SRR8216172
SAMN10450540	SRS4060852	SRR8216173
SAMN10450545	SRS4060851	SRR8216174
SAMN10450546	SRS4060850	SRR8216175
SAMN10450543	SRS4060849	SRR8216176
SAMN10450544	SRS4060847	SRR8216177
SAMN10450467	SRS4060848	SRR8216178
SAMN10450468	SRS4060846	SRR8216179
SAMN10450463	SRS4060843	SRR8216180
SAMN10450464	SRS4060844	SRR8216181
SAMN10450465	SRS4060845	SRR8216182
SAMN10450466	SRS4060842	SRR8216183
SAMN10450459	SRS4060841	SRR8216184
SAMN10450460	SRS4060840	SRR8216185
SAMN10450461	SRS4060839	SRR8216186
SAMN10450462	SRS4060838	SRR8216187
SAMN10450484	SRS4060837	SRR8216188
SAMN10450538	SRS4060836	SRR8216189
SAMN10450537	SRS4060835	SRR8216190
SAMN10450530	SRS4060834	SRR8216191
SAMN10450529	SRS4060833	SRR8216192
SAMN10450532	SRS4060832	SRR8216193
SAMN10450531	SRS4060831	SRR8216194
SAMN10450534	SRS4060830	SRR8216195
SAMN10450533	SRS4060829	SRR8216196
SAMN10450536	SRS4060828	SRR8216197
SAMN10450535	SRS4060827	SRR8216198
SAMN10450478	SRS4060826	SRR8216199
SAMN10450477	SRS4060825	SRR8216200
SAMN10450470	SRS4060824	SRR8216201
SAMN10450469	SRS4060823	SRR8216202
SAMN10450472	SRS4060822	SRR8216203
SAMN10450471	SRS4060821	SRR8216204
SAMN10450474	SRS4060820	SRR8216205
SAMN10450473	SRS4060819	SRR8216206
SAMN10450476	SRS4060818	SRR8216207
SAMN10450475	SRS4060817	SRR8216208
SAMN10450494	SRS4060816	SRR8216209
SAMN10450493	SRS4060815	SRR8216210
SAMN10450499	SRS4060814	SRR8216211
SAMN10450479	SRS4060813	SRR8216212
SAMN10450487	SRS4060812	SRR8216213
SAMN10450488	SRS4060811	SRR8216214
SAMN10450567	SRS4060810	SRR8216215
SAMN10450568	SRS4060809	SRR8216216
SAMN10450563	SRS4060808	SRR8216217
SAMN10450564	SRS4060807	SRR8216218
SAMN10450565	SRS4060806	SRR8216219
SAMN10450566	SRS4060805	SRR8216220
SAMN10450559	SRS4060803	SRR8216221
SAMN10450560	SRS4060804	SRR8216222
SAMN10450561	SRS4060802	SRR8216223
SAMN10450562	SRS4060801	SRR8216224
SAMN10450498	SRS4060800	SRR8216225
SAMN10450497	SRS4060799	SRR8216226
SAMN10450485	SRS4060798	SRR8216227
SAMN10450496	SRS4060797	SRR8216228
SAMN10450495	SRS4060796	SRR8216229
SAMN10450558	SRS4060795	SRR8216230
SAMN10450557	SRS4060793	SRR8216231
SAMN10450492	SRS4060794	SRR8216232
SAMN10450491	SRS4060792	SRR8216233
SAMN10450490	SRS4060791	SRR8216234
SAMN10450489	SRS4060790	SRR8216235
SAMN10450552	SRS4060789	SRR8216236
SAMN10450551	SRS4060788	SRR8216237
SAMN10450550	SRS4060787	SRR8216238
SAMN10450549	SRS4060786	SRR8216239
SAMN10450556	SRS4060785	SRR8216240
SAMN10450555	SRS4060784	SRR8216241
SAMN10450554	SRS4060783	SRR8216242
EOF
my %srsBySrr;
for my $line (split "\n", $payload){
  chomp $line;
  my ($samn, $srs, $srr) = split "\t", $line;
  $srsBySrr{$srr} = $srs;
}

my $header = <>;
chomp $header;
my ($sampleNameH, $samplingSiteH, $srrH, $srxH, $samnH, @header) = split "\t", $header;

#my @extraKeys = qw/body_product body_site host_common_name sample_type body_habitat country env_feature region/;

# body_product N/A
my @extraKeys = qw/host_common_name env_feature country region/;
# body_site -> internal organs or cuticle
# sample_type -> Adult/Larva internal/cuticle
# body_habitat -> internal microbiota / cuticle surface
my @extraValues = ("Anopheles albimanus", "Insect", "Guatemala", "V3V4");
say join ("\t", "name", "description",
  "body_site", "sample_type", "body_habitat",
  @extraKeys,
  "latitude", "longitude", "location", "site", 
  "exposure to pyrethroid insecticide",
  "host_life_stage",  
  "phenotype",
);
while(<>){
  chomp;
  my ($sampleName, $samplingSite, $srr, $srx, $samn, @line) = split "\t";
  #  my ($Sample_type, $Center_Name, $Collection_Date, $geo_loc_name_country, $geo_loc_name_country_continent, $geo_loc_name, $Latitude, $Longitude, $Host, $Instrument, $Replicate, $chem_administration, $host_sex, $gravidity, $Host_Age, $host_life_stage, $host_body_habitat, $Host_diet, $host_growth_cond, $host_phenotype, $host_taxid, $samp_size, $samp_store_dur, $samp_store_loc, $samp_store_temp) = @line;
  
  my %line = zip @header, @line;
  my $srs = $srsBySrr{$srr} or die "No SRS for $srr?";
  my $description = $sampleName;
  my $bodySite = 
    $line{"Sample type"} =~ m{internal} ? "internal organs" 
    : $line{"Sample type"} =~ m{cuticle} ? "cuticle"
    : die $sampleName;
  my $exposureToPyrethroidInsecticide = $line{chem_administration} eq 'none' ? "" : $line{chem_administration};
  my $hostLifeStage = $line{host_life_stage} eq 'Adult' ? 'Non-gravid adult female, 2-5 days old' : $line{host_life_stage} eq 'Larva' ? 'Larva, L3-L4 stage' : die $sampleName;
  say join("\t", "$srs.$srr", $description,
    $bodySite, $line{"Sample type"}, $line{host_body_habitat},
    @extraValues,
    $line{Latitude}, $line{Longitude}, $line{geo_loc_name}, $samplingSite, 
    $exposureToPyrethroidInsecticide,
    $hostLifeStage,
    $line{host_phenotype},
  );
}


